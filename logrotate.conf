# Logrotate configuration for AgentsFlowAI
# This file should be copied to /etc/logrotate.d/agentsflowai

# Application logs in /var/www/agentsflowai/logs/
/var/www/agentsflowai/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 deploy deploy
    sharedscripts
    postrotate
        # Reload PM2 processes to ensure they start writing to new log files
        sudo -u deploy pm2 reload ecosystem.config.js --env production || true
    endscript
    prerotate
        # Optional: Run commands before rotation
        # Could include flushing buffers or notifying monitoring systems
    endscript
}

# Nginx access and error logs
/var/log/nginx/agentsflowai_*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data adm
    sharedscripts
    postrotate
        # Send USR1 signal to nginx to reopen log files
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

# PM2 logs (if using PM2's built-in logging)
/home/deploy/.pm2/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 644 deploy deploy
    sharedscripts
    postrotate
        # PM2 automatically handles log rotation when using log_date_format
        # This is mainly for backup purposes
    endscript
}

# System logs related to the application
/var/log/syslog {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    sharedscripts
    postrotate
        # Restart rsyslog to apply changes
        /usr/lib/rsyslog/rsyslog-rotate || true
    endscript
}

# Custom log files for specific components
/var/www/agentsflowai/logs/database/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 deploy deploy
}

# Error logs with higher rotation frequency
/var/www/agentsflowai/logs/error*.log {
    hourly
    missingok
    rotate 168  # 7 days of hourly logs
    compress
    delaycompress
    notifempty
    create 644 deploy deploy
    sharedscripts
    postrotate
        # Notify monitoring system of new error logs
        # Could send alert or trigger analysis
    endscript
}
